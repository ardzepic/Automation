//USEUNIT General_Functions
//USEUNIT Dashboards_Functions
//USEUNIT BAQs_Functions
//USEUNIT Grid_Functions
//USEUNIT DataBase_Functions
//USEUNIT ControlFunctions
//USEUNIT Data_Dashboard_All_companies

function test(){
  //var parentWnd = Sys.Process("Epicor")
  //var test = FindObjects("*UltraToolbarsDockArea", ["Name"], ["*_Toolbars_Dock_Area_Top*"],parentWnd, 30 )
  var trackerMainPanel = RetrieveTrackerMainPanel()

  var test = FindObject("*Combo*", "Name", "*cboCustomer_Country*", trackerMainPanel[4])
  
  if(!test["Exists"]){
    Log["Message"]("Combo is not visible")
  } else{
    Log["Error"]("Combo is visible. Visible behavior not modified.")
  } 
  
  //  EnterText("txtMenuID", "test"+  "[Tab]", "Adding Dashboard name")
  //ClickButton("OK")
  
  //OpenPanelTab("Update->Update Processing")
  //ComboboxSelect("cboType","Dashboard-Assembly")
  
  //CheckboxState("chkInUse", true)
  //verifyCheckbox("chkInUs", true)
  
  //CheckboxState("chkAllCompanies", true)
  
  //var queryprops = FindObject("*TabControl", "Name", "*Query*")
 // var treePanel = FindObject("*TreeView*", "Name",  "*treeView*")

     //   treePanel["ClickItem"]("Updatable Fields|Customer_State")
  
 /* var username = "epicor"
  var password = "epicor"

  userField = GetTextBox("txtUserID")
  userField["Keys"](username + "[Tab]")

  passwordField = GetTextBox("txtPassword")
  passwordField["Keys"](password + "[Enter]")*/
} 

function RetrieveTrackerMainPanel(){
  var dashboardMainPanel =  FindTopMostForm()
    
  var trackerPDashboardChildren = dashboardMainPanel["FindAllChildren"]("FullName", "*TrackerPanel", 30)["toArray"]();
  return trackerPDashboardChildren
}

//Find only one object with specific parameters
function FindObject(className, props, vals, parentWnd, depth ){
  try{
    parentWnd = parentWnd? parentWnd : FindTopMostForm() 
    var objects =  FindObjects(className, props, vals, parentWnd, depth)

    if (objects["length"] > 1)
      Log["Message"](objects["length"] + " objects found")
    
    if(objects["length"] == 0){
      throw "Object not found"
    }

    return objects[0]

  }catch(e){
    // creates a stub object. This object has only one property, Exists, which equals False.
    return Utils.CreateStubObject()
  }
}

//Find objects with specific parameters
function FindObjects(className, props, vals, parentWnd, depth ){
      try{
        var objects = []
        var aClsNames = [].concat(className)
        var aProps = [].concat(props)
        var aVals = [].concat(vals)

        var depth = 30

        //@TODO:  
          //obtain the property name of an object 
          //-- at the moment hardcoded
                  var classPropertyName = aqObject.IsSupported(parentWnd, "ClrClassName") 
                    ? "ClrClassName"
                    : "WndClass"

        //Search paramenters is array (more than one property and value)
        if (aProps["length"] > 1 && aVals["length"] > 1) {
          if(aProps["length"] != aVals["length"]){
            throw "Mismatch with the number of arguments for search"
          }

          objects = parentWnd["FindAllChildren"](
                        CreateVarArray(classPropertyName, aProps, "Visible"),
                        CreateVarArray(className, aVals, "True"),
                          depth)["toArray"]()
        }
        //Search paramenters is not array (one property and value)
        else{
          for (i in aProps)
            for (j in aVals){            
                objects = parentWnd["FindAllChildren"](
                                    CreateVarArray(classPropertyName, aProps[i], "Visible"), 
                                    CreateVarArray(className, aVals[j], "True"), 
                                      depth)["toArray"]()
                // objects = objects.concat(objs) 
            }
        }

      }catch(e){
        Log["Error"](e["description"])
      }finally{
        return objects
      }
}

function GetObjectPath(object)
{
    var Vantage = Sys.Process("Epicor")

    return object["FullName"]
        ["replace"](Vantage["FullName"], "")                               //remove Vantage
        ["replace"](/(\[\"WinFormsObject\"\]|.WinFormsObject)\(\"/, "")    //remove leading obj name
        ["replace"](/(\[\"WinFormsObject\"\]|.WinFormsObject)\(\"/g, "/")  //replace obj name with slash
        ["replace"](/\"\)/g,"")                                            //remove ")
}


//FORM FUNCTIONS

/** Find and return the topmost opened window form. 
* @remark Tooltip windows are ignored. If no window found returns \a null*/
function FindTopMostForm(ignoreErr, ignoreLog)
{   
    // var form = getCachedTopForm() 
    // if (form)
        // return form
        
    // ignoreErr || CheckErrorWindow()
    //get all visible child forms 
    var forms = getAllVisibleForms()
    
    var topform = forms[0] 
    if (!ignoreLog) 
        Log["Message"]("Topmost form '" + GetObjectPath(topform) + "'", topform.WndCaption)    

    // addCachedForm(topform)
    return topform
}

//return array of visible forms (ignoring tooltips) sorted by index
function getAllVisibleForms()
{
    var Vantage = Sys.Process("Epicor")

    Vantage["Refresh"]()
    var forms = Vantage["FindAllChildren"](CreateVarArray("Visible", "Enabled", "VisibleOnScreen"), CreateVarArray("True", "True", "True"))["toArray"]()
    if (forms["length"] == 0)
    { 
        Delay(1000)
        Vantage["Refresh"]()
        var forms = Vantage["FindAllChildren"](CreateVarArray("Visible", "Enabled", "VisibleOnScreen"), CreateVarArray("True", "True", "True"))["toArray"]()
        if (forms["length"] == 0){
        // Check if TestComplete form is on top and minimize it
        //     MinimizeTestComplete()
            var forms = Vantage["FindAllChildren"](CreateVarArray("Visible", "Enabled", "VisibleOnScreen"), CreateVarArray("True", "True", "True"))["toArray"]()
    //no form found
            if (forms["length"] == 0)
                throw "getAllVisibleForms: No form found"
        }
    }
    //remove tooltip forms 
    var i = 0
    while (i < forms["length"]){
        if (forms[i]["Name"]["match"](/tooltip/i)){
            Log["Message"]("Tooltip popup window found", forms[i].FullName)
            forms["splice"](i, 1)
          }
        else 
            i++    
    }
    //sort by form index accending
    forms["sort"](sortFormsByIndex)

    function sortFormsByIndex(form1, form2)
    {
        if (form1["Index"] == form2["Index"]) return 0
        if (form1["Index"] < form2["Index"])  return -1
        else return 1         
    }
    return forms
}


/**Create variant(VBScript) array with passed arguments 
* @param arg1, arg2,. . ., argN \a optional New elements of an array
* @remark This function is commonly used within TestComplete Find, FindChild, FindAll methods */
function CreateVarArray(args)
{    
    var args = [].concat.apply([], arguments)
    
    var objDict = Sys.OleObject("Scripting.Dictionary")
//    objDict.RemoveAll()
    
    for (var i in args)
        objDict.Add(i, args[i])
    
    return objDict.Items()
}